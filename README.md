# Opentrons AI 协议生成器

这是一个基于人工智能的工具，可以帮助用户快速生成和验证 Opentrons 自动化液体处理机器人的实验协议。只需用自然语言描述您的实验需求，AI 将为您生成可立即使用的 Python 代码。

## 主要功能

- **AI 驱动的协议生成**：使用自然语言描述您的实验，AI 将根据您的描述生成完整的 Opentrons 协议
- **支持多种机器人型号**：兼容 Opentrons Flex 和 OT-2 机器人
- **多版本 API 支持**：支持选择从 2.14 到 2.21 的多个 API 版本
- **实时模拟验证**：生成的协议会立即通过模拟器验证，确保代码的正确性
- **错误分析与建议**：当模拟验证失败时，AI 会分析错误原因并提供具体改进建议
- **协议历史管理**：自动保存生成的协议，便于后续查看和使用
- **实时进度显示**：显示 AI 生成过程中的思考步骤和工具使用情况
- **简洁直观的用户界面**：使用 Streamlit 构建的友好界面，操作简单直观

## 安装与运行

### 系统要求

- Python 3.8 或更高版本
- 安装 pipenv 或 virtualenv (推荐使用隔离环境)

### 安装步骤

1. 克隆本仓库
    ```bash
git clone https://github.com/yourusername/opentrons-ai-protocol-generator.git
    cd opentrons-ai-protocol-generator 
    ```

2. 安装依赖
    ```bash
    pip install -r requirements.txt
    ```

3. 启动应用
```bash
streamlit run streamlit_app.py
```

应用将在本地启动，通常可以通过浏览器访问 `http://localhost:8501`。

## 使用方法

1. **选择机器人类型和 API 版本**：
   - 在左侧边栏选择您的 Opentrons 机器人类型（Flex 或 OT-2）
   - 选择匹配的 API 版本（根据您的 Opentrons 固件版本）

2. **描述您的实验**：
   - 在底部的聊天输入框中输入您的实验需求
   - 尽可能详细地描述您的实验步骤、使用的试剂、液体体积等信息

3. **查看生成结果**：
   - AI 会显示生成过程中的思考步骤
   - 生成的协议代码将显示在界面中
   - 模拟验证结果会自动显示

4. **下载或修改**：
   - 如果模拟成功，您可以直接下载生成的协议文件
   - 如果模拟失败，AI 会提供错误分析和改进建议
   - 您可以根据建议修改您的实验描述，重新生成协议

## 示例提问

- "生成一个方案，用1000uL移液器将A1孔的50uL液体转移到B2孔，使用Flex机器人和API 2.20"
- "设计一个实验，从源板的A1-A6孔吸取100uL液体，分别分配到目标板的B1-B6孔，并为每次转移更换吸头"
- "编写一个OT-2协议，API版本2.16，实现从第一列开始，在96孔板中进行1:2的连续稀释，共稀释6列，每孔总体积200uL"

## 技术架构

本项目采用以下技术：

- **Streamlit**：构建用户友好的Web界面
- **LangChain**：构建和管理AI代理工作流程
- **OpenAI API**：提供强大的自然语言处理和代码生成能力
- **Opentrons API**：用于协议模拟验证

主要组件：

1. **streamlit_app.py**：Web应用界面，处理用户交互和结果展示
2. **langchain_agent.py**：AI代理的核心逻辑，协调自然语言处理和代码生成
3. **opentrons_utils.py**：Opentrons协议模拟和验证功能
4. **config.py**：配置参数和API密钥管理

## 常见问题

**Q: 为什么模拟验证会失败？**  
A: 模拟失败可能有多种原因，如不兼容的硬件配置、液体体积不合理、位置错误等。AI 会分析具体原因并提供建议。

**Q: 我可以修改生成的代码吗？**  
A: 当然，生成的代码是标准的 Python 文件，您可以下载后根据需要进行修改。

**Q: 应用无法连接到API？**  
A: 请确保您已正确配置 API 密钥。如果问题持续，应用将在演示模式下运行，提供有限功能。

## 未来改进方向与建议

基于当前的技术栈和项目目标，以下是一些旨在提升协议生成速度和准确性的潜在改进方向：

### 1. 提升响应速度：引入异步操作

*   **目标**：减少用户等待时间，尤其是在调用外部大模型 API 时。
*   **核心技术**：Python 的 `asyncio` 库。
*   **实施建议**：
    *   识别项目中主要的 I/O 阻塞点，特别是 `langchain_agent.py` 中与 LLM 交互的部分。
    *   利用 LangChain 组件提供的异步方法（如 `arun`, `acall`, `apredict` 等），将相关函数改造为 `async def`。
    *   在主程序逻辑（例如 `run.py` 或替代 Streamlit 的新入口脚本）中使用 `asyncio.run()` 来执行异步代码。
    *   若涉及多个独立的耗时任务（如并行调用不同 LLM 功能或工具），可使用 `asyncio.gather()` 实现并发执行。
    *   评估 `opentrons_utils.py` 中的辅助函数，看是否有适合异步化的 I/O 操作。

### 2. 提高生成准确性：集成 RAG (Retrieval Augmented Generation)

*   **目标**：利用专业知识库增强大模型，确保生成的 SOP 和协议代码更符合 Opentrons 的规范和最佳实践。
*   **核心技术**：检索增强生成（RAG）。
*   **实施建议**：
    *   **构建知识库**：
        *   收集 Opentrons 官方 Python API 文档（关注项目使用的 PAPI 版本）。
        *   提取 `opentrons_utils.py` 中的关键函数逻辑和文档字符串。
        *   利用 `generated_protocols/` 目录下经过验证的高质量协议作为范例。
        *   整理任何内部积累的实验设计最佳实践、注意事项或错误排查指南。
    *   **选择 RAG 实现方式**：
        *   **方案 A (外部服务)**：评估如 `ragflow` 等 RAG 服务的 API，若其功能、易用性和数据策略符合要求，可简化搭建过程。需要在 `langchain_agent.py` 中集成 API 调用逻辑，获取上下文并注入 Prompt。
        *   **方案 B (自行搭建)**：使用 LangChain 或 LlamaIndex 等库，结合文档加载器、文本分割器、嵌入模型和向量数据库（如 FAISS, ChromaDB）自行构建 RAG 流程。这提供了更高的灵活性和控制力。
    *   **集成点**：
        *   在**SOP 生成阶段**，根据用户输入检索相关 API 用法、参数和注意事项，辅助生成准确的SOP。
        *   在**代码生成阶段**（SOP 转代码），检索具体的函数签名和代码示例，约束 LLM 生成规范代码。
        *   在**对话交互阶段**，直接利用 RAG 回答用户关于 Opentrons 的特定问题。
    *   **关键步骤**：
        *   设计有效的 RAG 查询策略。
        *   评估和优化检索结果的相关性。
        *   精心设计 Prompt，将检索到的上下文有效融入，引导 LLM 生成。
        *   从小范围知识库开始试验，逐步迭代优化。


## 问题与反馈

如果您在使用过程中遇到任何问题，或有改进建议，请通过以下方式联系我们：

- 提交 GitHub Issue
- 发送邮件至：[联系邮箱]

## 许可证

本项目采用 MIT 许可证 - 详情请参阅 LICENSE 文件

---

*本项目旨在简化 Opentrons 协议的创建过程，让更多研究人员能够轻松利用自动化实验设备。* 